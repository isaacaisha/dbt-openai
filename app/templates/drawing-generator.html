<!-- DRAWING-GENERATOR.HTML -->

{% extends 'header.html' %}

{% block title %} Drawing Generator {% endblock %}

{% block head %}
{{ super() }}
<link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='assets/images/favicon5.ico') }}">
{% include 'bootstrap/base.html' %}
<style>
    /* Responsive image container */
    .img-container {
        display: flex;
        justify-content: center;
        margin: 0 auto;
        max-width: 100%;
    }

    /* Responsive image */
    .img-container img {
        max-width: 100%;
        height: auto;
        width: auto;
    }
</style>
{% endblock %}

{% block content1 %}
<div class="container-fluid mb-5">
    <div class="p-1 rounded-3 jumbotron bg-dark text-light">
        <div class="container-fluid py-1">
            <h1 class="">
                <img src="{{ url_for('static', filename='assets/images/crown.webp') }}" alt="Crown Icon"
                    class="crown img-fluid mx-auto" width="100" height="100">
                Â·SÃ¬Ä¯SÃ­Â·DbtÂ· OpenAI
                <img src="{{ url_for('static', filename='assets/images/crown.webp') }}" alt="Crown Icon"
                    class="crown img-fluid mx-auto" width="100" height="100">
            </h1>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
{% autoescape true %}

<div class="content text-center">
    <form id="drawing-form" method="POST">
        {{ drawing_form.csrf_token }}

        <div id="error-message" class="alert alert-danger mb-3" style="display: none;"></div>

        <hr class="green mb-2">

        <div class="form-group align-left mb-3" style="width: 199px; margin: auto;">
            <label for="generationType" class="label_">Select Type of Generation:</label>
            <select id="generationType" name="generation_type" class="form-control text-center">
                <option value="generations">Generations</option>
                <option value="edits">Edits</option>
                <option value="face-to-sticker">Face To Sticker</option>
            </select>
        </div>

        <hr class="green mb-5">

        <div id="upload-container" class="form-group align-left mb-5"
            style="display: none; width: 199px; margin: auto;">
            <label for="imageUpload" class="label_">Upload Image for Edits or Variations:</label>
            <input type="file" id="imageUpload" name="image_upload" class="form-control">
        </div>

        <div id="textarea-container" class="align-left mb-5">
            <label for="generateDraw" class="label_">
                Start Writing to Generate a Drawing:<br>(be Specific for a better result)
            </label>
            <textarea class="form-control mb-3 align-left" id="generateDraw" name="generate_draw"></textarea>
        </div>

        <hr class="gold mb-3">

        <div id="loading-indicator" style="display:none;" class="text-center mb-3">
            <p>Loading...</p>
            <img class="loading"
                src="https://media1.giphy.com/media/VseXvvxwowwCc/200w.webp?cid=ecf05e47bx13l0iyjnyo8e0dxaumajijmsz83lk4bl8kow3w&ep=v1_gifs_search&rid=200w.webp&ct=g"
                alt="Loading">
        </div>
        <div id="loading-circle" class="load mb-3" style="display: none;"></div>

        <div class="text-center">
            <button id="generateButton" class="mb-3 btn generate-text" type="button">
                Generate The Drawing ðŸ”¥Â¡!Â¡
                <img src="{{ url_for('static', filename='assets/images/crown.webp') }}" class="crown">Â¡!Â¡ðŸ”¥
            </button>
        </div>

        <hr class="gold mb-5">

        <div style="height: auto; width: 100%;" class="mb-5">
            <div id="drawing-result" class="img-container mb-3"></div>
        </div>

        <button id="saveImage" class="nav-link mb-5 btn" style="margin: auto;"></button>
    </form>

    <script>
        document.getElementById('generationType').addEventListener('change', (event) => {
            const uploadContainer = document.getElementById('upload-container');
            if (event.target.value === 'edits' || event.target.value === 'face-to-sticker') {
                uploadContainer.style.display = 'block';
            } else {
                uploadContainer.style.display = 'none';
            }
        });

        document.getElementById('generateButton').addEventListener('click', async () => {
            const generateDraw = document.getElementById('generateDraw').value;
            const generationType = document.getElementById('generationType').value;
            const fileInput = document.getElementById('imageUpload');
            let fileData = null;

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.readAsDataURL(file);

                await new Promise((resolve) => {
                    reader.onloadend = () => {
                        fileData = reader.result.split(",")[1];
                        resolve();
                    };
                });
            }

            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('loading-circle').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';

            try {
                const response = await fetch('/drawing-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        generate_draw: generateDraw,
                        type: generationType,
                        image_data: fileData
                    })
                });

                const data = await response.json();

                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('loading-circle').style.display = 'none';

                if (response.ok) {
                    const imgContainer = document.getElementById('drawing-result');
                    imgContainer.innerHTML = `<img class="image_display" src="${data.drawing_url}" />`;

                    const saveButton = document.getElementById('saveImage');
                    saveButton.style.display = 'block';
                    saveButton.innerHTML = `<a href="${data.drawing_url}" download="generated_drawing.png">Save Image</a>`;
                } else {
                    throw new Error(data.error || 'An error occurred.');
                }
            } catch (error) {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('loading-circle').style.display = 'none';
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error-message').style.display = 'block';
            }
        });
    </script>
</div>

{% endautoescape %}
{% endblock %}
